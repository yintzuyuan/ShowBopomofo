# 此 workflow 不使用任何不可信的外部輸入，安全風險已評估
name: Update Phonetics Database

on:
  schedule:
    - cron: '0 0 * * 0'  # 每週日 00:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r scripts/requirements.txt

      - name: Download CNS11643 data
        run: |
          mkdir -p data
          git clone --depth=1 https://github.com/yintzuyuan/CNS11643-OpenData.git data/cns11643

      - name: Generate database
        run: python scripts/generate_phonetics_db.py --cns-data-dir data/cns11643

      - name: Verify database
        run: python scripts/verify_database.py

      - name: Check for changes
        id: check
        run: |
          DB_PATH="Show Chinese Phonetics.glyphsReporter/Contents/Resources/ShowChinesePhonetics_data.db"
          if git diff --quiet "$DB_PATH"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore: update phonetics database'
          title: 'chore: 更新注音資料庫'
          body: |
            ## 自動更新

            上游 CNS11643 資料有更新，已自動重新建置注音資料庫。

            **驗證**：
            - [x] 記錄數檢查通過
            - [x] 樣本字元驗證通過
            - [x] Unicode 格式驗證通過
          branch: chore/update-phonetics-db
          labels: automation,data-update
